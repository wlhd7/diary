{% extends "base.html" %}

{% block title %}Edit{% endblock %}
{% block body %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
          {% for category, message in messages %}
            <li class="flash {{ category }}">{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="post" action="{{ url_for('diary.edit', id=entry.id) }}">
        <label for="title">Title</label>
        <input id="title" name="title" value="{{ entry.title|e }}" required>
        <br>
        <label for="content">Content</label>
      <textarea id="content" name="content" rows="8">{{ entry.content|e }}</textarea>
        <br>
        <button type="submit">Save</button>
    </form>

    <form method="post" action="{{ url_for('diary.delete', id=entry.id) }}" onsubmit="return confirm('Delete this entry? This cannot be undone.');" style="margin-top:1rem">
      <button type="submit" class="danger">Delete</button>
    </form>

{% endblock %}

{% block scripts %}
  <script>
    (function(){
      const ta = document.getElementById('content');
      if (!ta) return;

      const MIN_CH = 40; // minimum width in ch units
      const MAX_CH = 120; // maximum width in ch units
      const PADDING_CH = 2; // extra characters padding

      function adjustWidth() {
        // split into lines and find the longest line length
        const lines = ta.value.split('\n');
        let maxLen = 0;
        for (let i = 0; i < lines.length; i++) {
          // use length; this measures characters roughly in ch units
          const l = lines[i].length;
          if (l > maxLen) maxLen = l;
        }

        let target = Math.max(MIN_CH, Math.min(MAX_CH, maxLen + PADDING_CH));
        // apply width in ch units; keep textarea responsive on small screens
        ta.style.width = target + 'ch';
        // allow the box to shrink on small screens
        ta.style.maxWidth = '100%';
        ta.style.boxSizing = 'border-box';
      }

      // initial adjust
      adjustWidth();

      // adjust on input
      ta.addEventListener('input', adjustWidth);
      // also adjust on window resize in case layout changes
      window.addEventListener('resize', adjustWidth);
    })();
  </script>
{% endblock %}
